name: Deploy OpenList to Cloudflare Workers

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24'

      - name: Install dependencies
        run: |
          npm ci
          cd pages
          npm ci
          cd ..

      - name: Install Wrangler and jq
        run: |
          npm install -g wrangler@latest
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Auto Create KV & D1 & Import Schema & Update wrangler.jsonc
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          # 备份 wrangler.jsonc
          cp wrangler.jsonc wrangler.jsonc.bak

          # 检查并创建 KV 命名空间
          echo "Creating KV namespace..."
          KV_OUTPUT=$(wrangler kv namespace create "KV_DATA" --binding "KV_DATA" --preview false --json 2>/dev/null || true)
          
          if [[ -n "$KV_OUTPUT" ]]; then
            KV_ID=$(echo "$KV_OUTPUT" | jq -r '.id // empty')
            echo "Created KV namespace with ID: $KV_ID"
          else
            # 如果已存在，从列表中获取 ID
            echo "KV namespace may already exist, fetching from list..."
            KV_ID=$(wrangler kv namespace list --json | jq -r '.[] | select(.title=="KV_DATA") | .id' | head -1)
            echo "Found existing KV namespace ID: $KV_ID"
          fi

          # 检查并创建 D1 数据库
          echo "Creating D1 database..."
          D1_OUTPUT=$(wrangler d1 create openlist-prod-db --json 2>/dev/null || true)
          
          if [[ -n "$D1_OUTPUT" ]]; then
            D1_ID=$(echo "$D1_OUTPUT" | jq -r '.uuid // empty')
            echo "Created D1 database with ID: $D1_ID"
          else
            # 如果已存在，从列表中获取 ID
            echo "D1 database may already exist, fetching from list..."
            D1_ID=$(wrangler d1 list --json | jq -r '.[] | select(.name=="openlist-prod-db") | .uuid' | head -1)
            echo "Found existing D1 database ID: $D1_ID"
          fi

          # 更新 wrangler.jsonc 文件
          echo "Updating wrangler.jsonc with IDs..."
          
          # 先读取当前配置
          CURRENT_CONFIG=$(cat wrangler.jsonc)
          
          # 更新 KV 部分（如果存在 KV_ID）
          if [[ -n "$KV_ID" ]]; then
            # 使用 sed 替换 KV 配置
            sed -i 's/"id": "your-kv-namespace-id"/"id": "'"$KV_ID"'"/' wrangler.jsonc
            echo "Updated KV ID in wrangler.jsonc"
          fi

          # 更新 D1 部分（如果存在 D1_ID）
          if [[ -n "$D1_ID" ]]; then
            # 使用 sed 替换 D1 配置
            sed -i 's/"database_id": "your-d1-database-id"/"database_id": "'"$D1_ID"'"/' wrangler.jsonc
            # 更新数据库名称
            sed -i 's/"database_name": "openlist-db"/"database_name": "openlist-prod-db"/' wrangler.jsonc
            echo "Updated D1 ID in wrangler.jsonc"
          fi

          # 等待文件写入完成
          sleep 2

          # 显示更新后的配置文件
          echo "Updated wrangler.jsonc:"
          cat wrangler.jsonc

          # 导入 schema.sql (如果存在)
          if [[ -f "./schema.sql" ]]; then
            echo "Importing schema.sql to D1 database..."
            wrangler d1 execute openlist-prod-db --remote --file=./schema.sql || echo "Schema import completed or skipped"
          fi

          # commit 修改后的 wrangler.jsonc
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add wrangler.jsonc
          git commit -m "chore: update KV & D1 bindings with actual IDs" || echo "No changes to commit"
          git push origin HEAD:main

      - name: Build frontend
        run: |
          cd pages
          npm run build
          cd ..

      - name: Deploy to Cloudflare Workers
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: deploy

      - name: Show deployment URL
        run: |
          # 使用 grep 和 sed 从 wrangler.jsonc 中提取 name 字段（避免使用 jq，因为 jsonc 可能有注释）
          WORKER_NAME=$(grep '"name"' wrangler.jsonc | head -1 | sed 's/.*"name": *"\([^"]*\)".*/\1/')
          echo "Deployment URL: https://${WORKER_NAME}.workers.dev"
